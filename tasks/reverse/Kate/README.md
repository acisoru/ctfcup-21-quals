# Reverse | hard | Kate

## Информация

> Наши агенты обнаружили новый экземпляр ВПО, используемый для атак на банковские организации города.
>
> У нас есть базовый семпл и трафик сгенерированный при его работе.
>
> Попробуй разобраться, что к чему и может у тебя получится получить данные, которые были зашифрованы.
> 
> *Пароль от архива: infected*
> 
> *Задача не содержит реального ВПО, всё что осуществляет файл в результате своей работы безвредно для вашего ПК*
> 

## Деплой

Не требуется

## Выдать участинкам

Архив из директории [public/](public/)

## Описание

PE 64bit, simple malware VM

## Решение

1. Нам дан исполняемый файл и трафик
2. Файл практически безверный, он шифрует файл "flag.png" и отправляет его по сети
3. В трафике с помощью статистики можно найти интересный IP-адрес (13.37.13.37)
4. Данные на этот адрес предаются по UDP. Сначала идёт пакет размером 48 байт, а потом большой бинарный блоб
5. Вероятно, это зашифрованные данные, а первый пакет служит некоторым инициализатором
6. Анализировать бинарь довольно проблематично, т.к. он реализует ВМ и запускает 4 модуля подряд
7. При этом в исполняемом файле не реализован механизмы противодействующие отладке
8. В основном модули выполняют простые функции, но они усложнены наличием виртуализации
9. Первый модуль проверяет подключен ли отладчик через функцию `IsDebuggerPresent`
10. При этом, если отладчик подключен, то исполняемый файл не завершит свою работу, а просто сгенерирует другой набор чисел для шифрование SID-а компьютера
11. Второй модуль осуществляет шифрование SID-а ПК
12. Третий модуль отправляет по сети зашифрованный SID
13. Четвёртый модуль отправляет зашифрованный файл
14. Файл шифруется с помощью AES_CBC, ключ и IV получаются из SID-а
15. Необходимо восстановить из трафика SID и сгенерировать из него ключ и IV


[Скрипт расшифроврки пакета в трафике](solution/decrypter.py)

## Флаг

`CUP{314e7940dc3081707a85a077503f2807}`